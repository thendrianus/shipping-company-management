<style>
    .datepicker {
        z-index: 1151 !important;
    }
</style>

<section class="panel panel-default">
    <header class="panel-heading font-bold">
        <p>Tambahkan pengiriman baru </p>
    </header>
    <div class="panel-body">

        <form class="form-horizontal" action="javascript:void(0);" id="form_absent">

            <div class="form-group">
                <label class="col-sm-2 control-label">Shipment ID</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" value="" id="s_id" disabled="disabled" required="required">
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Customer ID</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" value="" id="c_id" required="required">
                </div>
                <div class="col-sm-3">
                    <button class="btn btn-primary" value="add" id="edit_cus" onclick="button_action('a')"
                        formnovalidate="formnovalidate">Edit Customer</button>
                </div>
            </div>

            <div class="form-group">
                <label class="col-sm-2 control-label">Ship Trip ID</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" value="" id="s_t_id" required="required">
                </div>
                <div class="col-sm-3">
                    <button class="btn btn-primary" value="add" id="edit_trip" onclick="button_action('b')"
                        formnovalidate="formnovalidate">Edit Trip ID</button>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Ship Trip Detail ID</label>
                <div class="col-sm-3">
                    <input type="text" class="form-control" value="" id="s_t_d_id" required="required">
                </div>
                <div class="col-sm-3">
                    <button class="btn btn-primary" value="add" id="edit_trip" onclick="button_action('c')"
                        formnovalidate="formnovalidate">Edit Trip ID</button>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Receiver</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" value="" id="receiver">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Receiver Contact</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" value="" id="r_contact"
                        onkeyup="this.value = minmax(this.value, 0, 10000000000000)">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Shipted Date</label>
                <div class="col-sm-3">
                    <input class="input-sm input-s datepicker-input form-control" size="16" type="date"
                        value="2014-02-12" id="s_date" required="required" data-date-format="yyyy-mm-dd">
                </div>
                <div class="col-sm-2">
                    <div class="input-group clockpicker-with-callbacks">
                        <input type="time" class="form-control" value="22:10" id="s_time" required="required">
                        <span class="input-group-addon">
                            <span class="glyphicon glyphicon-time"></span>
                        </span>
                    </div>
                </div>

            </div>

            <div class="line line-dashed line-lg pull-in"></div>

            <div class="table-responsive">
                <table class="table table-striped b-t b-light" id="tabledata">
                    <thead>
                        <tr>
                            <th>Item Package</th>

                            <th>Price</th>

                            <th>Quantity</th>

                            <th>Discount(%)</th>

                            <th>Total</th>

                            <th>Note</th>

                            <th>Edit / Delete</th>

                        </tr>
                    </thead>

                    <tbody id="viewtable">

                    </tbody>
                </table>
            </div>

            <div class="line line-dashed line-lg pull-in"></div>

            <div class="form-group text-center">

                <button class="btn btn-primary" value="add_item" id="add_item" onClick="button_action('add_item')">Add
                    More Item</button>

            </div>
            <div class="line line-dashed line-lg pull-in"></div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Total</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" value="0" id="total" disabled="disabled" required="required"
                        onchange="count2()">
                </div>
            </div>


            <div class="form-group">
                <label class="col-sm-2 control-label">Extra Charge</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" value="0" id="extra"
                        onkeyup="this.value = extra_charge(this.value, 0, 10000000000000)">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Discount</label>
                <div class="col-sm-2">
                    <input type="number" class="form-control" id="persent" value="0" placeholder="Persent"
                        onkeyup="this.value = discount(this.value, 0, 100)">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Total Price</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" value="0" id="total_price" disabled="disabled"
                        required="required">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Payment</label>
                <div class="col-sm-4">
                    <select name="account" class="form-control m-b" id="payment">
                        <option value="1">Cash</option>
                        <option value="2">Cash On Delivery</option>
                    </select>
                </div>


            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Downpayment</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" value="0" id="dp"
                        onkeyup="this.value = downpayment(this.value, 0, 10000000000000)">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Sisa Pembayaran</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" value="0" id="payment2" disabled="disabled">
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Note</label>
                <div class="col-sm-10">
                    <textarea class="form-control" rows="3" placeholder="" id="note"></textarea>
                </div>
            </div>

            <div class="form-group text-center">

                <button class="btn btn-primary" value="add" id="formsubmit"
                    onClick="button_action('add_shipment')">Tambah Shipment</button>

            </div>
        </form>
    </div>
</section>


<div id="Modal_item" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Confirmation</h4>
            </div>
            <div class="modal-body">

                <form class="form-horizontal" action="javascript:void(0);" id="item_form">

                    <div class="form-group">
                        <label class="col-sm-2 control-label">Shipment Item Detail ID</label>
                        <div class="col-sm-3">
                            <input type="text" class="form-control" value="" id="item_detail" required="required">
                        </div>
                        <div class="col-sm-3">
                            <button class="btn btn-primary" value="add" id="edit_trip" onClick="button_action('d')"
                                formnovalidate="formnovalidate">Edit Trip ID</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Price</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" value="0" id="price" disabled="disabled"
                                readonly="readonly">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Quantity</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" value="1" id="quantity"
                                onkeyup="this.value = quantity_item(this.value, 1, 10000000000)" required="required">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Sub total</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" value="0" id="item_sub_total" disabled="disabled"
                                required="required">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Discount</label>

                        <div class="col-sm-2">
                            <input type="number" class="form-control" id="persent2" value="0" placeholder="Persent"
                                onkeyup="this.value = discount2(this.value, 0, 100)">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Total</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" value="0" id="item_detail_total" disabled="disabled"
                                value="0" required="required">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="col-sm-2 control-label">Note</label>
                        <div class="col-sm-10">
                            <textarea class="form-control" rows="3" placeholder="" id="item_note"></textarea>
                        </div>
                    </div>

                    <div class="line line-dashed line-lg pull-in"></div>

                    <div class="form-group text-center">

                        <button class="btn btn-primary" id="modal_submit" onClick="button_action('modal')">Add
                            Item</button>

                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

            </div>
        </div>
    </div>
</div>


<script>

    var d = new Date();
    var year = d.getFullYear();
    var month = ("0" + (d.getMonth() + 1)).slice(-2);
    var day = ("0" + d.getDate()).slice(-2)
    var hour = ("0" + d.getHours()).slice(-2);
    var m = ("0" + d.getMinutes()).slice(-2);
    var ws = "" + hour + ":" + m;

    var sdate = "" + year + "-" + month + "-" + day;
    $('#s_date').val(sdate);
    $('#s_time').val(ws);

    document.getElementById('dp').readOnly = true;
    document.getElementById('payment2').readOnly = true;

    function button_action(a) {
        if (a == "add_item") {
            var a = "" + document.getElementById('c_id').readOnly + "";
            var b = "" + document.getElementById('s_t_id').readOnly + "";
            var c = "" + document.getElementById('s_t_d_id').readOnly + "";

            if (a != "false" && b != "false" && c != "false") {
                add_item();
            }
        }
        else if (a == "add_shipmemnt") {

        }
        else if (a == 'a') {
            $('#c_id').val("");
            document.getElementById('c_id').readOnly = false;
        }
        else if (a == 'b') {
            $('#s_t_id').val("");
            document.getElementById('s_t_id').readOnly = false;
        }
        else if (a == 'c') {
            $('#s_t_d_id').val("");
            document.getElementById('s_t_d_id').readOnly = false;
        }
        else if (a == 'd') {
            document.getElementById('item_form').reset();
            document.getElementById('item_detail').readOnly = false;

        }
        else if (a == 'modal') {
            var a = "" + document.getElementById('s_t_d_id').readOnly + "";

            if (a != "false" && b != "false" && c != "false") {
                add_item();

            }

            modal_submit();
        }
        else if (a == 'add_shipment') {
            formsubmit();
            document.getElementById('form_absent').reset();
            document.getElementById('s_t_d_id').readOnly = false;
            document.getElementById('s_t_id').readOnly = false;
            document.getElementById('c_id').readOnly = false;
            $('#viewtable').html("");
        }
    }

    function formsubmit() {

        var TableData = new Array();

        $('#viewtable tr').each(function (row, tr) {
            TableData[row] = {
                "itemid": $(tr).find('td:eq(0)').text()
                , "price": $(tr).find('td:eq(1)').text()
                , "quantity": $(tr).find('td:eq(2)').text()
                , "discount": $(tr).find('td:eq(3)').text()
                , "total": $(tr).find('td:eq(4)').text()
                , "note": $(tr).find('td:eq(5)').text()
            }

        });

        itemData = JSON.stringify(TableData);
        var payment = $('#payment').val();
        if (payment == '2') {
            var spayment = 'Cash On Delivery';
            var pay = $('#dp').val();
        }
        if (payment != '2') {
            var spayment = 'Cash';
            var pay = $('#total_price').val();
        }
        var scusid = $('#c_id').val().split("-");
        var trip = $('#s_t_d_id').val().split("-");
        var sdate = '' + $('#s_date').val() + ' ' + $('#s_time').val() + ':00';
        $.post("process/addshipment.php", {
            action: 'add',
            id: '' + $('#s_id').val() + '',
            cusid: '' + scusid[0] + '',
            payment: '' + spayment + '',
            tripid: '' + trip[0] + '',
            receiver: '' + $('#receiver').val() + '',
            rcontact: '' + $('#r_contact').val() + '',
            date: '' + sdate + '',
            note: '' + $('#note').val() + '',
            extra: '' + $('#extra').val() + '',
            discount: '' + $('#persent').val() + '',
            itemdata: '' + itemData + '',
            pay: '' + pay + ''
        },
            function (data) {
                alert(data);
                getid();
            });

    }

    function minmax(value, min, max) {
        if (parseInt(value) < min || isNaN(value))
            return 0;
        else if (parseInt(value) > max)
            return 0;
        else return value;
    }

    function quantity_item(value, min, max) {
        if (parseInt(value) < min || isNaN(value)) {
            return 1;
        }
        else if (parseInt(value) > max) {
            return 1;
        }
        else {

            count(value, $('#persent2').val());
            return value;

        }
    }

    function downpayment(value, min, max) {
        if (parseInt(value) < min || isNaN(value)) {
            return 0;
        }
        else if (parseInt(value) > parseInt($('#total_price').val())) {
            return 0;
        }
        else {
            var value2 = 0;
            if (value != "") {
                value2 = value;
            }
            count2($('#extra').val(), $('#persent').val(), $('#payment').val(), value2);
            return value;

        }
    }

    function count(q, d) {
        var price = parseInt($('#price').val());
        $('#item_sub_total').val(price * q);
        var subtotal = parseInt($('#item_sub_total').val());
        if (d != 0) {
            var total = d / 100;
            $('#item_detail_total').val(subtotal - (subtotal * total));
        }
        else { $('#item_detail_total').val(subtotal); }
    }

    function count2(extra, dis, pay, dp) {

        var total = parseInt($('#total').val());
        var extra1 = parseInt(extra);
        var discount1 = parseInt(dis);
        var payment = parseInt(pay);
        var dp1 = parseInt(dp);
        if (dis != "0") {
            var discount = discount1 / 100;
            var totalp = (extra1 + total) - ((extra1 + total) * discount);
            $('#total_price').val(totalp);

        }
        else {
            $('#total_price').val((total + extra1));
        }

        if ($('#payment').val() == "2") {
            $('#payment2').val(parseInt($('#total_price').val()) - dp1);
        }

    }
    function discount(value, min, max) {

        if (parseInt(value) < min || isNaN(value)) {


            return 0;
        }
        else if (parseInt(value) > max) {

            return 100;
        }
        else {
            var value2 = 0;
            if (value != "") {
                value2 = value;
            }
            count2($('#extra').val(), value2, $('#payment').val(), $('#dp').val());
            return value;

        }

    }
    function extra_charge(value, min, max) {

        if (parseInt(value) < min || isNaN(value)) {
            return 0;
        }
        else if (parseInt(value) > max) {

            return 100;
        }
        else {
            var value2 = 0;
            if (value != "") {
                value2 = value;
            }
            count2(value2, $('#persent').val(), $('#payment').val(), $('#dp').val());
            return value;
        }


    }
    function discount2(value, min, max) {

        if (parseInt(value) < min || isNaN(value)) {
            return 0;
        }
        else if (parseInt(value) > max) {

            return 100;
        }
        else {

            count($('#quantity').val(), value);
            return value;


        }

    }

    getid();
    var trip;
    $(".datepicker-input").each(function () {
        $(this).datepicker();
    });

    function add_item() {
        $('#Modal_item').modal({
            backdrop: 'static',
            keyboard: false
        })
        $("#Modal_item").modal('show');
        trip = $('#s_t_id').val().split("-");
    }




    $('#payment').on('click', function () {
        var payment = $('#payment').val();
        if (payment == '2') {
            document.getElementById('dp').readOnly = false;
            document.getElementById('payment2').readOnly = false;

            $('#payment2').val($('#total_price').val());
        }
        if (payment != '2') {
            document.getElementById('dp').readOnly = true;
            document.getElementById('payment2').readOnly = true;
        }
    });

    function getid() {
        $.post("process/addshipment.php", {
            action: 'getid'
        },
            function (data) {
                var jsondata = JSON.parse(data);
                var d = new Date();
                var year = d.getYear() - 100;
                var month = ("0" + (d.getMonth() + 1)).slice(-2);
                var num = parseInt(jsondata[0].numrow) + 1;
                document.getElementById("s_id").value = "SPM" + year + month + num;
            });
    }


    $('#s_t_id').autocomplete({
        minLength: 2,
        source: function (request, response) {
            $.ajax({
                url: "process/addshipment.php",
                type: "POST",
                data: {
                    'action': 'get_item',
                    'trip': '' + $('#s_t_id').val() + '',
                    'name': '' + $('#item_detail').val() + ''
                },
                dataType: "json",
                success: function (data) {
                    response($.map(data, function (item) {
                        return {
                            label: item.label,
                            value: item.value,
                            price: item.price
                        }
                    }));
                }
            });
        },
        autoFocus: true,
        select: function (event, ui) {

            $('#item_detail').val('');
            $('#item_detail').val(ui.item.value);
            $('#price').val(ui.item.price);
            document.getElementById('item_detail').readOnly = true;


            return false;

        }

    });
    $('#c_id').autocomplete({
        minLength: 2,
        source: function (request, response) {
            $.ajax({
                url: "process/addshipment.php",
                type: "POST",
                data: {
                    'action': 'get_cus',
                    'name': '' + $('#c_id').val() + ''
                },
                dataType: "json",
                success: function (data) {
                    response($.map(data, function (item) {
                        return {
                            label: item.label,
                            value: item.value
                        }
                    }));
                }
            });
        },
        autoFocus: true,
        select: function (event, ui) {
            $('#c_id').val('');
            $('#c_id').val(ui.item.value);
            document.getElementById('c_id').readOnly = true;

            return false;
        }

    });
    $('#s_t_id').autocomplete({
        minLength: 2,
        source: function (request, response) {
            $.ajax({
                url: "process/addshipment.php",
                type: "POST",
                data: {
                    'action': 'tripdata',
                    'id': '',
                    'tripid': '' + $('#s_t_id').val() + '',
                    'departure': '',
                    'arrival': '',
                    'note': ''
                },
                dataType: "json",
                success: function (data) {
                    response($.map(data, function (item) {
                        return {
                            label: item.label,
                            value: item.value
                        }
                    }));
                }
            });

        },
        autoFocus: true,
        select: function (event, ui) {
            $('#s_t_id').val('');
            $('#s_t_id').val(ui.item.value);
            document.getElementById('s_t_id').readOnly = true;

            return false;
        }

    });
    $('#s_t_d_id').autocomplete({
        minLength: 2,
        source: function (request, response) {
            $.ajax({
                url: "process/addshipment.php",
                type: "POST",
                data: {
                    'action': 'tripdetaildata',
                    'tripdetailid': '' + $('#s_t_d_id').val() + '',
                    'tripid': '' + $('#s_t_id').val() + ''

                },
                dataType: "json",
                success: function (data) {
                    response($.map(data, function (item) {
                        return {
                            label: item.label,
                            value: item.value
                        }
                    }));
                }
            });

        },
        autoFocus: true,
        select: function (event, ui) {
            $('#s_t_d_id').val('');
            $('#s_t_d_id').val(ui.item.value);
            document.getElementById('s_t_d_id').readOnly = true;

            return false;
        }

    });

    $('#item_detail').autocomplete({
        minLength: 2,
        source: function (request, response) {
            $.ajax({
                url: "process/addshipment.php",
                type: "POST",
                data: {
                    'action': 'get_item',
                    'trip': '' + $('#s_t_id').val() + '',
                    'name': '' + $('#item_detail').val() + ''
                },
                dataType: "json",
                success: function (data) {
                    response($.map(data, function (item) {
                        return {
                            label: item.label,
                            value: item.value,
                            price: item.price
                        }
                    }));
                }
            });
        },
        autoFocus: true,
        select: function (event, ui) {

            $('#item_detail').val('');
            $('#item_detail').val(ui.item.value);
            $('#price').val(ui.item.price);
            document.getElementById('item_detail').readOnly = true;
            $('#quantity').val('1');
            $('#item_sub_total').val(ui.item.price);
            $('#item_detail_total').val(ui.item.price);
            $('#persent2').val('0');

            count(1, 0);

            return false;

        }

    });

    function modal_submit() {

        var tbl_row = document.getElementById("viewtable").rows.length + 1;

        var tr = "<tr id=\"" + $('#item_detail').val() + "\"><td>" + $('#item_detail').val() + "</td><td>" + $('#price').val() + "</td><td>" + $('#quantity').val() + "</td><td>" + $('#persent2').val() + "</td><td>" + $('#item_detail_total').val() + "</td><td>" + $('#item_note').val() + "</td>";
        var td1 = "<td><button class='btn btn-sm btn-default' type='submit' onClick=\"edititem('" + $('#item_detail').val() + "')\">Edit</button>    ";
        var td2 = "<button class='btn btn-sm btn-default' type='submit' onClick=\"deleteitem('" + tbl_row + "')\">Delete</button></td></tr>";
        $('#viewtable').append(tr + td1 + td2);
        var total = parseInt($('#total').val());
        var total2 = parseInt($('#item_detail_total').val());
        $('#total').val(total + total2);
        $('#total_price').val($('#total').val());
        document.getElementById('item_form').reset();
        document.getElementById('item_detail').readOnly = false;
    }

    function edititem(id) {

        var Cell = document.getElementById("viewtable").rows[id];

        document.getElementById('item_detail').value = Cell.cells[0].innerHTML;
        document.getElementById('price').value = Cell.cells[1].innerHTML;
        document.getElementById('quantity').value = Cell.cells[2].innerHTML;
        document.getElementById('persent2').value = Cell.cells[3].innerHTML;
        document.getElementById('item_detail_total').value = Cell.cells[4].innerHTML;
        document.getElementById('item_note').value = Cell.cells[5].innerHTML;
        $("#Modal_item").modal('show');
    }

    function deleteitem(id) {

        var Row = document.getElementById(id);
        document.getElementById("viewtable").deleteRow(Row);

    }
</script>

<script type="text/javascript">
    $('.clockpicker').clockpicker()
        .find('input').change(function () {
            console.log(this.value);
        });
    var input = $('#single-input').clockpicker({
        placement: 'bottom',
        align: 'left',
        autoclose: true,
        'default': 'now'
    });

    $('.clockpicker-with-callbacks').clockpicker({
        donetext: 'Done'

    })


    // Manually toggle to the minutes view

    if (/mobile/i.test(navigator.userAgent)) {
        $('input').prop('readOnly', true);
    }

</script>